<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>SSM Bastion with no NAT Gateway - Random Stuff From My Head</title><meta name=description content="Using Systems Manager (SSM) to control access to a Bastion host has several advantages making using a Traditional Bastion host using SSH Keys pretty much obsolete.
No need for an external IP No SSH Keys needed all access is via IAM Access logged including what command are run A working example can be found on GitHub
One of the biggest issues is that it requires access to AWS services to function so either a NAT gateway is required or VPC endpoints are needed"><meta name=author content="Neil Armitage"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Random Stuff From My Head","url":"https:\/\/neilarmitage.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/neilarmitage.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/neilarmitage.com\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/neilarmitage.com\/posts\/bastion_using_ssm\/","name":"Ssm bastion with no NAT gateway"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Neil Armitage"},"headline":"SSM Bastion with no NAT Gateway","description":"Using Systems Manager (SSM) to control access to a Bastion host has several advantages making using a Traditional Bastion host using SSH Keys pretty much obsolete.\nNo need for an external IP No SSH Keys needed all access is via IAM Access logged including what command are run A working example can be found on GitHub\nOne of the biggest issues is that it requires access to AWS services to function so either a NAT gateway is required or VPC endpoints are needed","inLanguage":"en","wordCount":406,"datePublished":"2022-12-05T08:43:21","dateModified":"2022-12-05T08:43:21","image":"https:\/\/neilarmitage.com\/","keywords":["AWS"],"mainEntityOfPage":"https:\/\/neilarmitage.com\/posts\/bastion_using_ssm\/","publisher":{"@type":"Organization","name":"https:\/\/neilarmitage.com\/","logo":{"@type":"ImageObject","url":"https:\/\/neilarmitage.com\/","height":60,"width":60}}}</script><meta property="og:title" content="SSM Bastion with no NAT Gateway"><meta property="og:description" content="Using Systems Manager (SSM) to control access to a Bastion host has several advantages making using a Traditional Bastion host using SSH Keys pretty much obsolete.
No need for an external IP No SSH Keys needed all access is via IAM Access logged including what command are run A working example can be found on GitHub
One of the biggest issues is that it requires access to AWS services to function so either a NAT gateway is required or VPC endpoints are needed"><meta property="og:url" content="https://neilarmitage.com/posts/bastion_using_ssm/"><meta property="og:type" content="website"><meta property="og:site_name" content="Random Stuff From My Head"><meta name=twitter:title content="SSM Bastion with no NAT Gateway"><meta name=twitter:description content="Using Systems Manager (SSM) to control access to a Bastion host has several advantages making using a Traditional Bastion host using SSH Keys pretty much obsolete.
No need for an external IP No SSH â€¦"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@narmitage"><meta name=twitter:creator content="@narmitage"><meta name=generator content="Hugo 0.107.0"><link rel=alternate href=https://neilarmitage.com/index.xml type=application/rss+xml title="Random Stuff From My Head"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://neilarmitage.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://neilarmitage.com/css/syntax.css><link rel=stylesheet href=https://neilarmitage.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://neilarmitage.com/>Random Stuff From My Head</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=about href=/about/>about</a></li><li><a title=talks href=https://speakerdeck.com/neilarmitage>talks</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>SSM Bastion with no NAT Gateway</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Using Systems Manager (SSM) to control access to a Bastion host has several advantages making using a Traditional Bastion host using SSH Keys pretty much obsolete.</p><ul><li>No need for an external IP</li><li>No SSH Keys needed all access is via IAM</li><li>Access logged including what command are run</li></ul><p>A working example can be found on <a href=https://github.com/narmitag/terraform-examples/tree/main/ssm_bastion>GitHub</a></p><p>One of the biggest issues is that it requires access to AWS services to function so either a NAT gateway is required or VPC endpoints are needed</p><p><img src=/images/ssm.png alt="Image alt"></p><p>The following endpoints need to be created to allow SSM to work without a NAT Gateway</p><ul><li>SSM</li><li>SSMMessages</li><li>EC2</li><li>EC2Messages</li><li>KMS</li><li>Logs</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-terraform data-lang=terraform><span class=line><span class=cl><span class=kr>module</span> <span class=s2>&#34;vpc_endpoints&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>source</span> = <span class=s2>&#34;terraform-aws-modules/vpc/aws//modules/vpc-endpoints&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>version</span> = <span class=s2>&#34;3.14.2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>vpc_id</span>             = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>vpc_id</span>
</span></span><span class=line><span class=cl>    <span class=na>security_group_ids</span> = <span class=p>[</span><span class=nb>data</span><span class=p>.</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>default</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>endpoints</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=na>ssm</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;ssm&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>        <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>vpc_tls</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=na>ssmmessages</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;ssmmessages&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>                <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>vpc_tls</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=na>ec2</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;ec2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>        <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nb>data</span><span class=p>.</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>default</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=na>ec2messages</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;ec2messages&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>                <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>vpc_tls</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=na>kms</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;kms&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>        <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>vpc_tls</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=na>logs</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>service</span>             = <span class=s2>&#34;logs&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>private_dns_enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>subnet_ids</span>          = <span class=nb>module</span><span class=p>.</span><span class=nx>vpc</span><span class=p>.</span><span class=nx>private_subnets</span>
</span></span><span class=line><span class=cl>        <span class=na>security_group_ids</span>  = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>vpc_tls</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The instance deployed is just a standard AWS AL2 instance with the IAM manged role <code>arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore</code> attached to it via an instance profile.</p><p>The Terraform example here includes things like logging and KMS encryption which could be removed. All the command run on the bastion are recorded in Cloudwatch logs along with the name of the IAM user who ran them.</p><p>To connect to the host there is a bash script in <code>client\ssh_terminal</code> which will locate the bastion in AWS and start a session to it. Basically it is running the command</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws ssm start-session --target <span class=s2>&#34;</span><span class=si>${</span><span class=nv>INSTANCE_ID</span><span class=si>}</span><span class=s2>&#34;</span> --region <span class=s2>&#34;</span><span class=si>${</span><span class=nv>REGION</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>The instance can also be used for Port forwarding, this is a bit hacky but works. This will allow connection from your local machine to a remote host via the bastion.</p><p><img src=/images/port_forward.png alt="Image alt"></p><p>Step 1: Start an SSH session to the bastion and run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>socat TCP-LISTEN:4222,reuseaddr,fork TCP4:10.200.36.194:4222
</span></span></code></pre></div><p>Step 2: On your local machine start a port forwarding SSM Session</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> aws ssm start-session --target &#34;${INSTANCE_ID}&#34; \
</span></span><span class=line><span class=cl>         --document-name AWS-StartPortForwardingSession \
</span></span><span class=line><span class=cl>         --parameters &#39;{&#34;portNumber&#34;:[&#34;4222&#34;],&#34;localPortNumber&#34;:[&#34;9999&#34;]}&#39;
</span></span></code></pre></div><p>Step 3: Connect to port 9999 locally which will forward via the Bastion to port 4333 on 10.200.36.194</p><div class=blog-tags><a href=https://neilarmitage.com//tags/aws/>AWS</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://neilarmitage.com/posts/terraform_testing/ data-toggle=tooltip data-placement=top title="Terraform Testing">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:neil@neilarmitage.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/narmitag title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/narmitage title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/neil-a-5750885 title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=neilarmitage.com>Neil Armitage</a>
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://neilarmitage.com/>Random Stuff From My Head</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.107.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/narmitag/narmitag.github.io/ca434445f7d71c796fb9dedcee2a37485e361be1>ca434445</a>]</p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://neilarmitage.com/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://neilarmitage.com/js/load-photoswipe.js></script></body></html>